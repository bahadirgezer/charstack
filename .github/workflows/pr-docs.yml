name: PR Documentation

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-describe:
    name: Auto-describe PR
    runs-on: [self-hosted, macOS, ARM64, bgpro-charstack]
    # Only run if the PR body is blank, still has our auto-generated footer, or if the PR is still open
    if: github.event.pull_request.body == '' || github.event.pull_request.body == null || contains(github.event.pull_request.body, '_Generated by Gemini 2.0 Flash_') || github.event.pull_request.state == 'open'

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Collect diff info
        id: diff
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          git fetch origin "$BASE_BRANCH" --depth=100
          PR_HEAD_REF="refs/pull/${PR_NUMBER}/head"
          git fetch origin "$PR_HEAD_REF" --depth=1
          PR_HEAD="$(git rev-parse FETCH_HEAD)"
          DIFF_STAT="$(git diff --stat "origin/$BASE_BRANCH"...$PR_HEAD)"
          DIFF_CONTENT="$(git diff "origin/$BASE_BRANCH"...$PR_HEAD -- '*.swift' '*.yml' '*.json' '*.md' | head -3000)"
          COMMITS="$(git log --oneline "origin/$BASE_BRANCH".."$PR_HEAD")"

          # Write to temp files to avoid shell quoting issues
          echo "$DIFF_STAT" > /tmp/diff_stat.txt
          echo "$DIFF_CONTENT" > /tmp/diff_content.txt
          echo "$COMMITS" > /tmp/commits.txt

      - name: Debug secret presence
        run: |
          if [[ -n "${{ secrets.GEMINI_API_KEY }}" ]]; then
            echo "Secret is available to this run"
          else
            echo "Secret is NOT available to this run"
          fi

      - name: Generate AI description
        id: ai
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [[ -z "$GEMINI_API_KEY" ]]; then
            echo "has_ai=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          COMMITS="$(cat /tmp/commits.txt)"
          DIFF_STAT="$(cat /tmp/diff_stat.txt)"
          DIFF_CONTENT="$(cat /tmp/diff_content.txt)"

          PROMPT="You are a technical writer for an iOS Swift project. Given the git diff and commit log below, write a concise PR description in markdown.

          Format:
          ## Summary
          <2-4 bullet points describing WHAT changed and WHY>

          ## Changes
          <grouped list of specific changes>

          Rules: Be concise and factual. Focus on the what and why, not the how. No filler phrases. Do not wrap in code fences."

          BODY="$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              --arg diff "$DIFF_STAT" \
              --arg content "$DIFF_CONTENT" \
              --arg commits "$COMMITS" \
              '{contents: [{parts: [{text: ($prompt + "\n\n--- COMMITS ---\n" + $commits + "\n\n--- DIFF STAT ---\n" + $diff + "\n\n--- DIFF (truncated) ---\n" + $content)}]}]}'
            )" | jq -r '.candidates[0].content.parts[0].text // empty')"

          if [[ -n "$BODY" ]]; then
            printf '%s\n\n---\n_Generated by Gemini 2.0 Flash_' "$BODY" > /tmp/pr_body.md
            echo "has_ai=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_ai=false" >> "$GITHUB_OUTPUT"
            echo "::warning::Gemini returned empty response."
          fi

      - name: Update PR description (AI)
        if: steps.ai.outputs.has_ai == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit "${{ github.event.pull_request.number }}" \
            --body "$(cat /tmp/pr_body.md)"

      - name: Update PR description (fallback)
        if: steps.ai.outputs.has_ai != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          DIFF_STAT="$(cat /tmp/diff_stat.txt)"
          COMMITS="$(cat /tmp/commits.txt)"
          BODY="$(printf '## Commits\n```\n%s\n```\n\n## Diff summary\n```\n%s\n```' "$COMMITS" "$DIFF_STAT")"
          gh pr edit "${{ github.event.pull_request.number }}" --body "$BODY"
