name: PR Documentation

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  pull-requests: write
  contents: read

concurrency:
  group: pr-docs-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  update-pr-docs:
    name: Update PR docs
    runs-on: [self-hosted, macOS, ARM64, bgpro-charstack]
    if: github.event.pull_request.head.repo.full_name == github.repository
    env:
      PR_DOCS_DIR: /tmp/pr-docs-${{ github.run_id }}-${{ github.run_attempt }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_ACTION: ${{ github.event.action }}
      PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
      PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
      PR_BEFORE_SHA: ${{ github.event.before }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_MERGED: ${{ github.event.pull_request.merged }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GEMINI_MODEL: gemini-2.0-flash

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate Gemini secret
        run: |
          if [[ -z "${GEMINI_API_KEY:-}" ]]; then
            echo "::error::Missing GEMINI_API_KEY repository secret."
            exit 1
          fi

      - name: Collect PR context
        run: .github/scripts/pr-docs-collect.sh

      - name: Generate PR docs with Gemini
        id: ai
        run: |
          set +e
          .github/scripts/pr-docs-generate-ai.sh
          status=$?
          set -e

          if [[ $status -eq 0 ]]; then
            echo "mode=ai" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ $status -eq 42 ]]; then
            echo "mode=fallback" >> "$GITHUB_OUTPUT"
            echo "Gemini usage limit reached. Using fallback formatter."
            exit 0
          fi

          exit $status

      - name: Build fallback PR docs
        if: steps.ai.outputs.mode == 'fallback'
        run: .github/scripts/pr-docs-build-fallback.sh

      - name: Merge docs into PR body
        id: merge
        run: .github/scripts/pr-docs-merge-body.sh

      - name: Update PR description
        if: steps.merge.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit "$PR_NUMBER" --body-file "$PR_DOCS_DIR/final_pr_body.md"

      - name: No PR description change
        if: steps.merge.outputs.changed != 'true'
        run: echo "PR description already up to date."
