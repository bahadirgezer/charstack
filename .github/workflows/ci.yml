name: CI

on:
  pull_request:
    branches: ["develop", "main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: [self-hosted, macOS, ARM64, bgpro-charstack]
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select Xcode (optional)
        if: ${{ vars.XCODE_APP_PATH != '' }}
        run: |
          set -euo pipefail
          sudo xcode-select -s "${{ vars.XCODE_APP_PATH }}"
          xcodebuild -version

      - name: Read VERSION
        id: ver
        run: |
          set -euo pipefail
          V="$(tr -d '[:space:]' < VERSION)"
          if ! [[ "$V" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "VERSION must be x.y.z (e.g., 1.2.3). Got: '$V'"
            exit 1
          fi
          echo "version=$V" >> "$GITHUB_OUTPUT"

      - name: Install CocoaPods (if needed)
        run: |
          set -euo pipefail
          if [[ -f "Podfile" ]]; then
            if [[ -f "Gemfile" ]]; then
              bundle install
              bundle exec pod install
            else
              pod install
            fi
          fi

      - name: Detect workspace/project + scheme
        id: xcode
        run: |
          set -euo pipefail

          WORKSPACE="${{ vars.XCODE_WORKSPACE }}"
          PROJECT="${{ vars.XCODE_PROJECT }}"
          SCHEME="${{ vars.XCODE_SCHEME }}"

          if [[ -z "$WORKSPACE" && -z "$PROJECT" ]]; then
            WS="$(ls -1 *.xcworkspace 2>/dev/null | head -n 1 || true)"
            PRJ="$(ls -1 *.xcodeproj 2>/dev/null | head -n 1 || true)"
            if [[ -n "$WS" ]]; then WORKSPACE="$WS"; fi
            if [[ -z "$WORKSPACE" && -n "$PRJ" ]]; then PROJECT="$PRJ"; fi
          fi

          if [[ -n "$WORKSPACE" ]]; then
            echo "container=-workspace $WORKSPACE" >> "$GITHUB_OUTPUT"
          elif [[ -n "$PROJECT" ]]; then
            echo "container=-project $PROJECT" >> "$GITHUB_OUTPUT"
          else
            echo "Could not find *.xcworkspace or *.xcodeproj at repo root."
            echo "Set vars.XCODE_WORKSPACE or vars.XCODE_PROJECT."
            exit 1
          fi

          CONTAINER_LINE="$(grep '^container=' "$GITHUB_OUTPUT" | tail -n 1 | cut -d= -f2-)"
          if [[ -z "$SCHEME" ]]; then
            DETECTED="$(CONTAINER_LINE="$CONTAINER_LINE" python3 - <<'PY'
            import json, subprocess, os, shlex
            container_line = os.environ["CONTAINER_LINE"]
            container = shlex.split(container_line)
            cmd = ["xcodebuild"] + container + ["-list", "-json"]
            out = subprocess.check_output(cmd)
            data = json.loads(out)
            obj = data.get("workspace") or data.get("project") or {}
            schemes = obj.get("schemes") or []
            print(schemes[0] if len(schemes) == 1 else "")
            PY
            )"
            if [[ -z "$DETECTED" ]]; then
              echo "Multiple schemes found. Set vars.XCODE_SCHEME."
              exit 1
            fi
            SCHEME="$DETECTED"
          fi

          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: Build & Test (simulator)
        run: |
          set -euo pipefail
          VERSION="${{ steps.ver.outputs.version }}"
          BUILDNUM="${{ github.run_number }}"
          CONTAINER_LINE="${{ steps.xcode.outputs.container }}"
          SCHEME="${{ steps.xcode.outputs.scheme }}"

          # Expand "CONTAINER_LINE" into args safely:
          python3 - <<PY
          import os, shlex, subprocess
          container_line = os.environ["CONTAINER_LINE"]
          scheme = os.environ["SCHEME"]
          version = os.environ["VERSION"]
          buildnum = os.environ["BUILDNUM"]

          container_args = shlex.split(container_line)
          cmd = ["xcodebuild", *container_args,
                "-scheme", scheme,
                "-sdk", "iphonesimulator",
                "-destination", "platform=iOS Simulator,name=iPhone 15",
                "-configuration", "Debug",
                f"MARKETING_VERSION={version}",
                f"CURRENT_PROJECT_VERSION={buildnum}",
                "clean", "test"]
          print("Running:", " ".join(shlex.quote(c) for c in cmd))
          subprocess.check_call(cmd)
          PY
        env:
          CONTAINER_LINE: ${{ steps.xcode.outputs.container }}
          SCHEME: ${{ steps.xcode.outputs.scheme }}
          VERSION: ${{ steps.ver.outputs.version }}
          BUILDNUM: ${{ github.run_number }}
