name: Release

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  tag-and-release:
    name: Tag & Release
    runs-on: [self-hosted, macOS, ARM64, bgpro-charstack]
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Select Xcode
        if: vars.XCODE_APP_PATH != ''
        run: |
          sudo xcode-select -s "${{ vars.XCODE_APP_PATH }}"
          xcodebuild -version

      # ── Check if VERSION changed (skip release if not) ──
      - name: Check VERSION changed
        id: changed
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BEFORE="${{ github.event.before }}"
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git diff --name-only "$BEFORE" "${{ github.sha }}" | grep -qx "VERSION"; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
          else
            echo "proceed=false" >> "$GITHUB_OUTPUT"
            echo "No VERSION change — skipping release."
          fi

      # ── Read & validate VERSION ──
      - name: Read VERSION
        if: steps.changed.outputs.proceed == 'true'
        id: ver
        run: |
          V="$(tr -d '[:space:]' < VERSION)"
          if ! [[ "$V" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::VERSION must be x.y.z — got '$V'"
            exit 1
          fi
          TAG="v$V"
          if git ls-remote --tags origin "refs/tags/$TAG" | grep -q .; then
            echo "::error::Tag $TAG already exists."
            exit 1
          fi
          echo "version=$V" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      # ── Create & push tag ──
      - name: Create tag
        if: steps.changed.outputs.proceed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.ver.outputs.tag }}" -m "Release ${{ steps.ver.outputs.tag }}"
          git push origin "${{ steps.ver.outputs.tag }}"

      # ── Build release archive ──
      - name: Resolve Xcode project
        if: steps.changed.outputs.proceed == 'true'
        id: xcode
        run: .github/scripts/resolve-xcode-project.sh
        env:
          INPUT_WORKSPACE: ${{ vars.XCODE_WORKSPACE }}
          INPUT_PROJECT: ${{ vars.XCODE_PROJECT }}
          INPUT_SCHEME: ${{ vars.XCODE_SCHEME }}

      - name: Build archive
        if: steps.changed.outputs.proceed == 'true'
        run: |
          mkdir -p build
          xcodebuild \
            "${{ steps.xcode.outputs.flag }}" "${{ steps.xcode.outputs.path }}" \
            -scheme "${{ steps.xcode.outputs.scheme }}" \
            -configuration Release \
            -archivePath build/App.xcarchive \
            MARKETING_VERSION="${{ steps.ver.outputs.version }}" \
            CURRENT_PROJECT_VERSION="${{ github.run_number }}" \
            clean archive

      - name: Zip archive
        if: steps.changed.outputs.proceed == 'true'
        run: |
          /usr/bin/ditto -c -k --sequesterRsrc --keepParent \
            build/App.xcarchive build/App.xcarchive.zip

      # ── Generate changelog from git log ──
      - name: Generate changelog
        if: steps.changed.outputs.proceed == 'true'
        run: |
          TAG="${{ steps.ver.outputs.tag }}"
          PREV_TAG="$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname \
            | grep -vx "$TAG" | head -1 || true)"

          {
            echo "# Changelog — $TAG"
            echo
            if [[ -n "$PREV_TAG" ]]; then
              echo "_Changes since ${PREV_TAG}_"
              echo
              git log --no-merges --pretty=format:"- %s" "${PREV_TAG}..HEAD"
            else
              echo "_Initial release_"
              echo
              git log --no-merges --pretty=format:"- %s"
            fi
            echo
          } > build/CHANGELOG.md

      # ── AI-enhanced release notes (optional, requires GEMINI_API_KEY secret) ──
      - name: Generate AI release notes
        if: steps.changed.outputs.proceed == 'true'
        id: ai_notes
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [[ -z "$GEMINI_API_KEY" ]]; then
            echo "body=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CHANGELOG="$(cat build/CHANGELOG.md)"
          BODY="$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg log "$CHANGELOG" '{
              contents: [{parts: [{text: ("Write concise, user-friendly release notes for an iOS app based on this changelog. Group changes by category (Features, Fixes, Maintenance). Use markdown. Be brief.\n\n" + $log)}]}]
            }')" | jq -r '.candidates[0].content.parts[0].text // empty')"

          if [[ -n "$BODY" ]]; then
            # Write to file to avoid shell quoting issues
            echo "$BODY" > build/RELEASE_NOTES.md
            echo "has_notes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
          fi

      # ── Create GitHub Release ──
      - name: Create GitHub Release
        if: steps.changed.outputs.proceed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          body_path: ${{ steps.ai_notes.outputs.has_notes == 'true' && 'build/RELEASE_NOTES.md' || '' }}
          generate_release_notes: ${{ steps.ai_notes.outputs.has_notes != 'true' }}
          files: |
            build/App.xcarchive.zip
            build/CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
