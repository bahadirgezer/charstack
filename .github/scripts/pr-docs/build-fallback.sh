#!/usr/bin/env bash
set -euo pipefail

: "${PR_DOCS_DIR:?PR_DOCS_DIR is required}"

CONTEXT_JSON="$PR_DOCS_DIR/context.json"
if [[ ! -f "$CONTEXT_JSON" ]]; then
  echo "::error::Missing context file: $CONTEXT_JSON"
  exit 1
fi

ACTION="$(jq -r '.action' "$CONTEXT_JSON")"
PR_NUMBER="$(jq -r '.pr_number' "$CONTEXT_JSON")"
TITLE="$(jq -r '.title' "$CONTEXT_JSON")"
MERGED="$(jq -r '.merged' "$CONTEXT_JSON")"
PUSH_CONTEXT_AVAILABLE="$(jq -r '.push_context_available' "$CONTEXT_JSON")"

FULL_SHORTSTAT="$(cat "$PR_DOCS_DIR/full_shortstat.txt")"
PUSH_SHORTSTAT="$(cat "$PR_DOCS_DIR/push_shortstat.txt")"

if [[ -z "${FULL_SHORTSTAT//[[:space:]]/}" ]]; then
  FULL_SHORTSTAT="No full diff summary available."
fi

if [[ "$ACTION" == "closed" ]]; then
  if [[ "$MERGED" == "true" ]]; then
    STATE_LINE="PR closed as merged."
  else
    STATE_LINE="PR closed without merge."
  fi
else
  STATE_LINE="PR action: $ACTION."
fi

if [[ "$ACTION" == "synchronize" && "$PUSH_CONTEXT_AVAILABLE" == "true" && -n "${PUSH_SHORTSTAT//[[:space:]]/}" && "$PUSH_SHORTSTAT" != "N/A" ]]; then
  THIS_PUSH_LINE="$PUSH_SHORTSTAT"
  COMMIT_SOURCE_FILE="$PR_DOCS_DIR/push_commits.txt"
else
  THIS_PUSH_LINE="No incremental push delta for this event."
  COMMIT_SOURCE_FILE="$PR_DOCS_DIR/full_commits.txt"
fi

COMMITS="$(sed -n '1,8p' "$COMMIT_SOURCE_FILE")"
if [[ -z "${COMMITS//[[:space:]]/}" || "$COMMITS" == "N/A" ]]; then
  COMMITS="- No commit list available."
fi

cat > "$PR_DOCS_DIR/generated_block.md" <<EOF_BLOCK
## At a Glance
- #${PR_NUMBER}: ${TITLE}
- ${STATE_LINE}
- Full PR diff: ${FULL_SHORTSTAT}

## This Push
- ${THIS_PUSH_LINE}

## Commits
${COMMITS}

---
_Autogenerated fallback (Gemini usage limit reached)._
EOF_BLOCK

echo "Fallback PR docs generated."
